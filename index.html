<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hyperline Express – Route Price Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); }
    .soft-card { box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    /* Improve select contrast */
  select{ color:#E5E7EB; background-color:rgba(2,6,23,0.4);} 
  select option{ color:#111827; background:#ffffff;}
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-950 via-blue-900 to-blue-950 text-slate-100">
  <header class="max-w-6xl mx-auto px-4 pt-10 pb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-amber-400/20 border border-amber-300/30 grid place-items-center">
          <span class="text-amber-300 font-black">HX</span>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Hyperline Express</h1>
          <p class="text-slate-300/80 -mt-0.5">Fast · Flexible · Secure</p>
        </div>
      </div>
      <a href="#how-to" class="text-sm text-amber-300 hover:underline">Deploy on GitHub Pages →</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 grid lg:grid-cols-3 gap-6 pb-16">
    <!-- Calculator -->
    <section class="lg:col-span-2 glass soft-card rounded-2xl p-6">
      <h2 class="text-xl font-bold mb-4">Route Price Calculator</h2>

      <form id="calcForm" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Origin</label>
          <input list="hublist" id="origin" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., Jita" />
        </div>
        <div>
          <label class="block text-sm mb-1">Destination</label>
          <input list="hublist" id="destination" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., Amarr / Parchanier" />
        </div>

        <div>
          <label class="block text-sm mb-1">Security Band</label>
          <select id=\"security\" class=\"w-full rounded-xl bg-blue-900/40 text-slate-100 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400\">
            <option value="HS">High-Sec</option>
            <option value="LS">Low-Sec</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">Ship Type</label>
          <select id=\"ship\" class=\"w-full rounded-xl bg-blue-900/40 text-slate-100 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400\">
            <option value="BRDST">BR / DST (≤ 50,000 m³, ≤ 1.5B collateral)</option>
            <option value="FREIGHTER">Freighter (≤ 350,000 m³, ≤ 1B collateral, HS only)</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">Volume (m³)</label>
          <input id="volume" type="number" min="0" step="1" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., 50000" />
        </div>
        <div>
          <label class="block text-sm mb-1">Collateral (ISK)</label>
          <input id="collateral" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., 1.5B or 750M" />
        </div>

        <div>
          <label class="block text-sm mb-1">Jumps (if not a hub route)</label>
          <input id="jumps" type="number" min="0" step="1" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., 14" />
        </div>
        <div>
          <label class="block text-sm mb-1">Speed</label>
          <select id=\"speed\" class=\"w-full rounded-xl bg-blue-900/40 text-slate-100 border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400\">
            <option value="standard">Standard (48–72h)</option>
            <option value="sameday">Same-day (≤24h)</option>
            <option value="express">Express (≤6h)</option>
          </select>
        </div>

        <div class="md:col-span-2 flex flex-wrap items-center gap-4 pt-2">
        </div>

        <div class="md:col-span-2 flex items-center gap-3 pt-2">
          <button type="button" id="calcBtn" class="px-4 py-2 rounded-xl bg-amber-400 hover:bg-amber-300 text-slate-900 font-semibold">Calculate</button>
          <button type="button" id="copyBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/15">Copy EVEmail Quote</button>
          <span id="status" class="text-sm text-slate-300/80"></span>
        </div>
      </form>

      <datalist id="hublist">
        <option value="Jita"></option>
        <option value="Amarr"></option>
        <option value="Dodixie"></option>
        <option value="Hek"></option>
        <option value="Rens"></option>
        <option value="Parchanier"></option>
      </datalist>

      <div class="mt-6 grid md:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
          <h3 class="font-semibold mb-2">Result</h3>
          <div id="result" class="text-lg leading-relaxed">
            <div class="text-slate-300">Fill the form and click <span class="font-semibold">Calculate</span>.</div>
          </div>
        </div>
        <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
          <h3 class="font-semibold mb-2">Notices & Validation</h3>
          <ul id="notices" class="space-y-2 text-sm text-slate-200"></ul>
        </div>
      </div>
    </section>

    <!-- Conditions / Pricing -->
    <aside class="glass soft-card rounded-2xl p-6 space-y-5">
      <h2 class="text-xl font-bold">Conditions & Limits</h2>
      <div class="space-y-3 text-sm">
        <div>
          <h4 class="font-semibold">BR / DST</h4>
          <ul class="list-disc ml-5 leading-relaxed text-slate-200">
            <li>Capacity: ≤ <strong>50,000 m³</strong></li>
            <li>Collateral: ≤ <strong>1.5B</strong> ISK</li>
            
            
            
          </ul>
        </div>
        <div>
          <h4 class="font-semibold">Freighter</h4>
          <ul class="list-disc ml-5 leading-relaxed text-slate-200">
            <li>Capacity: ≤ <strong>350,000 m³</strong></li>
            <li>Collateral: ≤ <strong>1B</strong> ISK</li>
            
            
          </ul>
        </div>
        <div>Jita⇄Amarr: <strong>50M / 90M / 150M</strong></div>
              <div>Jita⇄Dodixie: <strong>25M / 68M / 125M</strong></div>
              <div>Jita⇄Hek: <strong>30M / 60M / 110M</strong></div>
              <div>Jita⇄Rens: <strong>25M / 52M / 90M</strong></div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 p-3">
              <div class="font-semibold">Freighter</div>
              <div>Jita⇄Amarr: <strong>100M / 150M / 250M</strong></div>
              <div>Jita⇄Dodixie: <strong>40M / 110M / 190M</strong></div>
              <div>Jita⇄Hek: <strong>55M / 119M / 170M</strong></div>
              <div>Jita⇄Rens: <strong>50M / 109M / 160M</strong></div>
            </div>
          </div>
        </div>
        <div>
          <h4 class="font-semibold">Speed Multipliers</h4>
          <ul class="list-disc ml-5 leading-relaxed text-slate-200">
            <li>Standard (48–72h): <strong>+0%</strong></li>
            <li>Same-day (≤24h): <strong>+25%</strong></li>
            <li>Express (≤6h): <strong>+100%</strong> (on request & subject to availability)</li>
          </ul>
        </div>
        <div>
  <h4 class=\"font-semibold\">Custom Pricing</h4>
  <ul class=\"list-disc ml-5 leading-relaxed text-slate-200\">
    <li>For recurring or high-volume contracts, <strong>contact us</strong> for tailored partner rates.</li>
  </ul>
</div>
      </div>
    </aside>
  </main>

  <section id="how-to" class="max-w-6xl mx-auto px-4 pb-20">
    <div class="glass soft-card rounded-2xl p-6">
      <h2 class="text-xl font-bold mb-3">How to deploy on GitHub Pages</h2>
      <ol class="list-decimal ml-5 space-y-2 text-sm text-slate-200">
        <li>Create a new GitHub repository (e.g., <em>hyperline-express</em>).</li>
        <li>Add this file as <code>index.html</code> to the root of the repository and commit.</li>
        <li>Go to <strong>Settings → Pages</strong> and set <em>Source</em> to your <strong>main</strong> branch, <em>root</em> folder.</li>
        <li>Save. Your site will be available at <em>https://&lt;your-user&gt;.github.io/&lt;repo&gt;</em> after a short build.</li>
      </ol>
      <p class="mt-3 text-xs text-slate-400">Optional: customize colors, add your logo, or edit the rates in the script below.</p>
    </div>
  </section>

  <script>
    // ---------- Helpers ----------
    const byId = (id) => document.getElementById(id);
    const fmtM = (n) => `${(Math.round(n * 10) / 10).toFixed(1)}M ISK`;
    const parseISK = (s) => {
      if (!s) return 0;
      const t = s.toString().trim().toLowerCase();
      const m = t.endsWith('b') ? 1e9 : t.endsWith('m') ? 1e6 : t.endsWith('k') ? 1e3 : 1;
      const v = parseFloat(t.replace(/[^0-9.\-]/g, '')) * m;
      return isNaN(v) ? 0 : v;
    };
    const routeKey = (a, b) => [a, b].map(x => (x||'').trim()).sort((x, y) => x.localeCompare(y)).join('—');

    // ---------- Data ----------
    // ---------- ESI helpers ----------
    const ESI = 'https://esi.evetech.net/latest';
    
    async function systemIdByName(name) {
      const q = encodeURIComponent((name || '').trim());
      if (!q) return null;
      const url = `${ESI}/search/?categories=solar_system&search=${q}&strict=true&datasource=tranquility`;
      const r = await fetch(url);
      if (!r.ok) return null;
      const data = await r.json();
      return (data.solar_system && data.solar_system[0]) || null;
    }
    
    async function getRouteSystemIds(originId, destId) {
      const url = `${ESI}/route/${originId}/${destId}/?flag=shortest&datasource=tranquility`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('ESI route error');
      return r.json(); // array de system_ids
    }
    
    const _secCache = new Map();
    async function getSecurityStatus(systemId) {
      if (_secCache.has(systemId)) return _secCache.get(systemId);
      const url = `${ESI}/universe/systems/${systemId}/?datasource=tranquility`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('ESI system error');
      const data = await r.json();
      const sec = Number(data.security_status); // -1.0 .. 1.0
      _secCache.set(systemId, sec);
      return sec;
    }
    
    function classifySec(sec) {
      if (sec >= 0.5) return 'HS';
      if (sec > 0.0)  return 'LS';
      return 'NS';
    }

    
    const FIXED_BRDST = {
      'Amarr—Jita': { standard: 50, sameday: 90, express: 150 },
      'Dodixie—Jita': { standard: 25, sameday: 68, express: 125 },
      'Hek—Jita': { standard: 30, sameday: 60, express: 110 },
      'Jita—Rens': { standard: 25, sameday: 52, express: 90 },
      'Amarr—Jita': { standard: 50, sameday: 90, express: 150 },
      'Jita—Amarr': { standard: 50, sameday: 90, express: 150 }, // redundancy-safe
      'Jita—Dodixie': { standard: 25, sameday: 68, express: 125 },
      'Jita—Hek': { standard: 30, sameday: 60, express: 110 },
      'Rens—Jita': { standard: 25, sameday: 52, express: 90 },
    };

    const FIXED_FREIGHTER = {
      'Amarr—Jita': { standard: 100, sameday: 150, express: 250 },
      'Dodixie—Jita': { standard: 40, sameday: 110, express: 190 },
      'Hek—Jita': { standard: 55, sameday: 119, express: 170 },
      'Jita—Rens': { standard: 50, sameday: 109, express: 160 },
      'Jita—Amarr': { standard: 100, sameday: 150, express: 250 },
      'Jita—Dodixie': { standard: 40, sameday: 110, express: 190 },
      'Jita—Hek': { standard: 55, sameday: 119, express: 170 },
      'Rens—Jita': { standard: 50, sameday: 109, express: 160 },
    };

    const RATES = {
      BRDST: { HS: 3, LS: 6, MIN: 20, COLLIM: 1.5e9, VOLLIM: 50000 },
      FREIGHTER: { HS: 4, LS: null, MIN: 30, COLLIM: 1e9, VOLLIM: 350000 },
    };

    // Límites (se muestran en el panel lateral, ya lo tienes)
    const LIMITS = {
      BRDST: { COLLIM: 1.5e9, VOLLIM: 50000, MIN: 20 },
      FREIGHTER: { COLLIM: 1e9,  VOLLIM: 350000, MIN: 30 },
    };
    
    // Tarifas internas (no se muestran en la UI)
    const HIDDEN_RATES = {
      BRDST: { HS: 3, LS: 6 },     // M ISK por salto
      FREIGHTER: { HS: 4 }         // HS only
    };
    
    const SPEED_FACTOR = { standard: 1, sameday: 1.25, express: 2 };

    function findFixedPrice(ship, a, b, speed) {
      const key = routeKey(a, b);
      const table = ship === 'FREIGHTER' ? FIXED_FREIGHTER : FIXED_BRDST;
      return table[key]?.[speed] ?? null;
    }

    async function calc() {
    const origin = byId('origin').value || '';
    const destination = byId('destination').value || '';
    const ship = byId('ship').value;         // BRDST o FREIGHTER
    const volume = Number(byId('volume').value || 0);
    const collateral = parseISK(byId('collateral').value || '');
    const speed = byId('speed').value;       // standard/sameday/express
    const roundtrip = byId('roundtrip')?.checked || false;
    const backhaul20 = byId('backhaul20')?.checked || false;
  
    const notices = [];
    const lim = LIMITS[ship];
  
    // Validaciones básicas
    if (volume > lim.VOLLIM) notices.push(`Volume exceeds ${lim.VOLLIM.toLocaleString()} m³ limit for ${ship}.`);
    if (collateral > lim.COLLIM) notices.push(`Collateral exceeds ${(lim.COLLIM/1e9)}B ISK limit for ${ship}.`);
  
    // 1) Resolver IDs
    const [oId, dId] = await Promise.all([systemIdByName(origin), systemIdByName(destination)]);
    if (!oId || !dId) {
      byId('result').innerHTML = `<div class="text-rose-300">Unknown system name(s). Check spelling.</div>`;
      byId('notices').innerHTML = notices.map(n=>`<li class="text-rose-300">${n}</li>`).join('');
      return;
    }
  
    // 2) Ruta real
    const pathIds = await getRouteSystemIds(oId, dId); // [sys0, sys1, ...]
    const jumps = Math.max(0, (pathIds?.length || 0) - 1);
  
    // 3) Seguridad por salto (tomamos el sistema de destino de cada salto)
    const destIds = pathIds.slice(1);
    const secs = await Promise.all(destIds.map(getSecurityStatus));
    const counts = secs.reduce((acc, s) => {
      const band = classifySec(s);
      acc[band]++; return acc;
    }, { HS:0, LS:0, NS:0 });
  
    // 4) Precio por leg según nave y seguridad
    let legPriceM = 0;
    if (ship === 'BRDST') {
      const hsM = counts.HS * HIDDEN_RATES.BRDST.HS;
      const lowOrNullM = (counts.LS + counts.NS) * HIDDEN_RATES.BRDST.LS; // NS usa tarifa LS por defecto
      legPriceM = hsM + lowOrNullM;
      if (counts.NS > 0) notices.push('Null-sec detected on route. Service subject to availability.');
    } else {
      // FREIGHTER: solo HS
      if (counts.LS > 0 || counts.NS > 0) {
        notices.push('Route crosses Low/Null-sec. Freighter is HS-only. Choose BR/DST or set a HS-only path.');
        byId('result').innerHTML = `<div class="text-rose-300">Freighter pricing unavailable for this route (LS/NS present).</div>`;
        byId('notices').innerHTML = notices.map(n=>`<li class="text-rose-300">${n}</li>`).join('');
        return;
      }
      legPriceM = jumps * HIDDEN_RATES.FREIGHTER.HS;
    }
  
    // 5) Mínimo por leg + velocidad
    legPriceM = Math.max(legPriceM, lim.MIN);
    legPriceM *= (SPEED_FACTOR[speed] || 1);
  
    // 6) Round trip / backhaul
    const outbound = legPriceM;
    const inbound = roundtrip ? (backhaul20 ? legPriceM * 0.8 : legPriceM) : 0;
    const total = outbound + inbound;
  
    // 7) Render
    const secBadge = `HS: ${counts.HS} · LS: ${counts.LS} · NS: ${counts.NS}`;
    byId('result').innerHTML = `
      <div class="text-3xl font-extrabold mb-1">${fmtM(total)}</div>
      <div class="text-sm mb-1">Jumps: <strong>${jumps}</strong> · Security legs: <strong>${secBadge}</strong></div>
      <div class="text-sm mb-3">Speed: <span class="font-semibold capitalize">${speed.replace('sameday','same-day')}</span> · ${roundtrip?'Round trip (backhaul ' + (backhaul20?'-20%':'no') + ')':'One-way'}</div>
      <div class="text-slate-300">Leg price: <strong>${fmtM(legPriceM)}</strong> ${roundtrip?`· Outbound: ${fmtM(outbound)} · Return: ${fmtM(inbound)}`:''}</div>
    `;
    byId('notices').innerHTML = notices.length
      ? notices.map(n=>`<li class="text-rose-300">${n}</li>`).join('')
      : '<li class="text-emerald-300">Route fetched from ESI. All inputs within limits.</li>';
  
    // Devuelve estado para el botón “Copy EVEmail Quote”
    return { origin, destination, ship, volume, collateral, speed, roundtrip, backhaul20, jumps, counts, total, legPriceM, outbound, inbound, notices };
  }
      
      

      const notices = [];

      // Validation
      const cfg = RATES[ship];
      if (!cfg) return;
      if (volume > cfg.VOLLIM) notices.push(`Volume exceeds ${cfg.VOLLIM.toLocaleString()} m³ limit for ${ship}.`);
      if (collateral > cfg.COLLIM) notices.push(`Collateral exceeds ${(cfg.COLLIM/1e9)}B ISK limit for ${ship}.`);
      if (ship === 'FREIGHTER' && security === 'LS') notices.push('Freighter pricing is HS only.');

      // Try fixed route pricing first
      let legPrice = findFixedPrice(ship, origin, destination, speed);

      // Jita⇄Parchanier volume tier override (per leg)
      
      if (legPrice == null) {
        // Per-jump pricing
        const rate = cfg[security];
        if (rate == null) {
          notices.push('Selected ship/security combo has no per-jump rate.');
        }
        const base = Math.max((jumps || 0) * (rate || 0), cfg.MIN);
        legPrice = base * (SPEED_FACTOR[speed] || 1);
      }

      // Now compute totals
      let outbound = legPrice;
      let inbound = roundtrip ? legPrice : 0;

      if (roundtrip && backhaul20) inbound = inbound * 0.8;

      let total = outbound + inbound;
      

      // Render result
      const breakdown = [
        `<div><span class='text-slate-300'>Leg price:</span> <strong>${fmtM(legPrice)}</strong></div>`,
        roundtrip ? `<div><span class='text-slate-300'>Outbound:</span> ${fmtM(outbound)} · <span class='text-slate-300'>Return:</span> ${fmtM(inbound)}</div>` : `<div><span class='text-slate-300'>One-way:</span> ${fmtM(outbound)}</div>`,
        
        backhaul20 && roundtrip ? `<div><span class='text-slate-300'>Backhaul discount (return leg):</span> −20%</div>` : '',
      ].filter(Boolean).join('');

      byId('result').innerHTML = `
        <div class="text-3xl font-extrabold mb-1">${fmtM(total)}</div>
        <div class="text-sm mb-3">Total price ${roundtrip ? '(round trip)' : '(one way)'} — speed: <span class="font-semibold capitalize">${speed.replace('sameday','same‑day')}</span></div>
        ${breakdown}
      `;

      byId('notices').innerHTML = notices.length
        ? notices.map(n => `<li class="text-rose-300">${n}</li>`).join('')
        : '<li class="text-emerald-300">All inputs within limits.</li>';

      return { origin, destination, security, ship, volume, collateral, jumps, speed, roundtrip, backhaul20, partner20, jitaParTier, total, legPrice, outbound, inbound, notices };
    }

    function toEvemail(state) {
      const lines = [];
      lines.push(`Subject: Quote – Hyperline Express`);
      lines.push('');
      lines.push(`Route: ${state.origin} → ${state.destination}${state.roundtrip ? ' → ' + state.origin : ''}`);
      lines.push(`Ship: ${state.ship === 'BRDST' ? 'BR/DST' : 'Freighter'} · Security: ${state.security}`);
      lines.push(`Speed: ${state.speed}`);
      lines.push(`Volume: ${state.volume.toLocaleString()} m³ · Collateral: ${state.collateral.toLocaleString()} ISK`);
      if (!Object.keys(FIXED_BRDST).includes(routeKey(state.origin, state.destination)) && !Object.keys(FIXED_FREIGHTER).includes(routeKey(state.origin, state.destination))) {
        lines.push(`Jumps: ${state.jumps}`);
      }
      lines.push('');
      
      
      if (state.backhaul20 && state.roundtrip) lines.push(`Backhaul discount: −20% on return leg.`);
      lines.push('');
      lines.push(`Price: ${fmtM(state.total)}${state.roundtrip ? ` (Outbound ${fmtM(state.outbound)} + Return ${fmtM(state.inbound)})` : ''}`);
      lines.push('');
      lines.push(`Terms: Standard 48–72h · Same‑day +25% (availability) · Express +100% (on request).`);
      return lines.join('\n');
    }

    byId('calcBtn').addEventListener('click', () => {
      const st = calc();
      byId('status').textContent = 'Calculated ✔';
      setTimeout(() => (byId('status').textContent = ''), 1500);
    });

    byId('copyBtn').addEventListener('click', () => {
      const st = calc();
      const text = toEvemail(st);
      navigator.clipboard.writeText(text).then(() => {
        byId('status').textContent = 'Quote copied to clipboard';
        setTimeout(() => (byId('status').textContent = ''), 1500);
      });
    });
  </script>
</body>
</html>
